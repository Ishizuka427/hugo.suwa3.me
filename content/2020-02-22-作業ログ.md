---
title: "ä½œæ¥­ãƒ­ã‚°"
date: "2020-02-22T13:00:00.000Z"
categories: 
  - "log"
  - "tech-blog"
tags: 
  - "mastodon"
---

ä»Šæ—¥ã‹ã‚‰ç´ ç›´ã§å¯æ„›ã’ã®ã‚ã‚‹é§†ã‘å‡ºã—ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ãªã‚‹ã€‚  
ãªã®ã§ã€sshãƒ­ã‚°ã‚¤ãƒ³å¾Œãã¡ã‚“ã¨screenã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ä½œæ¥­ã‚’å§‹ã‚ã‚‹ã€‚

[https://qiita.com/hnishi/items/3190f2901f88e2594a5f](https://qiita.com/hnishi/items/3190f2901f88e2594a5f)

```
 $ screen
```

ã¾ãšå‰å›ã‚„ã£ãŸä½œæ¥­ã®è¨˜æ†¶ã‚’å‘¼ã³è¦šã¾ã™ãŸã‚ã«  
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã¦historyè¦‹ã¤ã¤ä½•ã‚’ã™ã‚‹ã‹æ€ã„å‡ºã™ã€‚

```
$ sudo su -
$ sudo su mastodon
$ cd /home/mastodon/live/
```

ã‚¢ã‚»ãƒƒãƒˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‹ã‚‰ã ã£ãŸã€‚

```
$ RAILS_ENV=production bundle exec rails assets:precompile
 yarn install v1.21.1
 [1/6] Validating package.jsonâ€¦
 [2/6] Resolving packagesâ€¦
 [3/6] Fetching packagesâ€¦
```

CPUãŒå¼µã‚Šä»˜ãã¾ã—ãŸã€‚

![](images/ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ-2020-02-23-18.08.27.png)

ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’è¦‹ã‚ˆã†ã«ã‚‚  
`$ free` ã‚³ãƒãƒ³ãƒ‰ãŒæ‰“ã¦ãªã„ã€‚

ç„¡æ–™æ ã§ä½•ã¨ã‹ã—ãŸã„ã®ã§  
t2.microã§å‡ºæ¥ã‚‹ã ã‘ã‚„ã£ã¦ã¿ã‚‹ğŸ˜¢

OSSã§è©°ã‚“ã ã‚‰ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚€ã‚¿ã‚¤ãƒ ã ã‚ˆã€‚  
ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç·å½“ã‚Šã‚’ã—ãªãŒã‚‰  
ãã‚Œã£ã½ã„ã‚‚ã®ã‚’æ¢ã™ä½œæ¥­ã§ã™ã€‚jsã«ç™ºç‹‚ã—ã¦ããŸã‚‰æ°´ã‚’é£²ã‚“ã§è½ã¡ç€ã“ã†ã€‚

[https://github.com/tootsuite/mastodon/blob/master/config/webpack/configuration.js](https://github.com/tootsuite/mastodon/blob/master/config/webpack/configuration.js)

â†‘æœ€å¾Œã®æ–¹ã«outputã¨ã„ã†å˜èªã‚’è¦‹ã¤ã‘ãŸã€‚  
é€†ç®—ã—ã¦`public_output_path` => `webpacker.yml`ã®è¡Œæ–¹ã‚’è¿½ã„ã¾ã™ã€‚  
publicé…ä¸‹ã®packsã£ã½ã„ã“ã¨ãŒåˆ¤æ˜ã—ãŸã€‚

æ‰“é–‹ç­–ã¨ã—ã¦Dockerå†…ã®  
`/opt/mastodon/public/packs`  
ã‚’ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã—ã¦ãƒ›ã‚¹ãƒˆã«ç§»å‹•ã•ã›ã¦  
ãã®ã¾ã¾åœ§ç¸®ã—ã¦EC2ã«é€ã‚‹ä½œæˆ¦ã§ã„ãã¾ã™ã€‚

**ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæ¥­  
**ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’DockerHubã§è¦‹ã¤ã‘ã¦ããŸã®ã§pull

```
$ docker pull tootsuite/mastodon:v2.9.3
$ docker images
REPOSITORY            TAG      IMAGE ID       CREATED            SIZE
tootsuite/mastodon    v2.9.3   ca1472193a01   6 months ago     1.47GB
```

èµ·å‹•ã•ã›ã¤ã¤ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ãƒ›ã‚¹ãƒˆã¨ç¹‹ã’ã‚‹ã€‚

```
$ docker run -v /tmp:/tmp -it tootsuite/mastodon:v2.9.3 sh
$ pwd
 /opt/mastodon
$ cd public
```

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®tmpä»¥ä¸‹ã«cp

```
$ cp packs /tmp/ -R
```

tmpã«ç§»å‹•ã—ã¦ç¢ºèª

```
$ cd /tmp
$ ls
packs
```

tarã‚³ãƒãƒ³ãƒ‰ã§åœ§ç¸®ã™ã‚‹

```
$ tar -zcvf packs.tar.gz packs
$ ls
packs                packs.tar.gz
```

scpã§é€ã‚‹

```
$ scp -i ~/.ssh/**.pem packs.tar.gz ******@**.168.**.**:~/
```

**ã‚µãƒ¼ãƒãƒ¼ã«ç§»å‹•** (EC2)

```
$ screen
```

è§£å‡ã™ã‚‹

```
$ tar -xzvf packs.tar.gz
```

publicé…ä¸‹ã«ç§»å‹•

```
$ sudo mv packs /home/mastodon/live/public/
```

æ¨©é™ã¨ã‹é©å½“ã«æ•´ãˆã‚‹

```
$ cd /home/mastodon/live/public/
$ chown -R mastodon:mastodon packs
```

```
$ service mastodon-web restart
```

ï¼¿äººäººäººäººäººäººäººäººäººäººï¼¿  
ï¼ã€€502 Bad Gatewayã€€ï¼œ  
ï¿£Y^Y^Y^Y^Y^Y^Y^Yï¿£

**ãªã‚“ã§ã‚„ã­ã‚“**

ãƒ­ã‚°ã®ç¢ºèª

```
$ journalctl -f
(ç•¥)
connections on Unix domain socket "/var/run/postgresql/.s.PGSQL.5432"?
(ç•¥)
```

é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ä»¶ã¯è§£æ±ºã—ãŸã‘ã‚Œã©ã€PostgreSQLãŒä½•ã‹ãƒ€ãƒ¡ã£ã½ã„ã€‚ä¸€é›£å»ã£ã¦ã¾ãŸä¸€é›£â€¦

```
/home/mastodon/live$ vim .env.production
```

```
$ service mastodon-web restart
$ service mastodon-web status
â— mastodon-web.service - mastodon-web
  Loaded: loaded (/etc/systemd/system/mastodon-web.service; disabled; vendor preset: enabled)
  Active: active (running) since Sun 2020-02-23 11:58:59 UTC; 4s ago
```

ç©ºè…¹ã§è¦–ç•ŒãŒéœã‚“ã§ããŸã®ã§ã€ä»Šæ—¥ã¯ã“ã“ã¾ã§ã€‚  
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä½œæ¥­ãŒçµ‚ã‚ã£ãŸã‚‰è½ã¨ã—ã¦ãŠãã€‚
